<!DOCTYPE html>
<html lang=en-us>
<meta charset=utf-8>
<title>Exercise 2018</title>
<meta name=viewport content="width=device-width,initial-scale=1">
<link rel=icon href=deadlift.png>
<style>
body {
  font-family: HelveticaNeue, Helvetica Neue, Helvetica, Arial, sans-serif;
  margin: 0;
  padding: 5px;
  box-sizing: content-box;
  background: #ddd;
  display: grid;
  grid-gap: 5px;
  grid-template-areas:
    "header"
    "squat"
    "deadlift"
    "press"
    "cal";
}
@media (min-width: 684px) {
  body {
    grid-template-columns: repeat(3, 1fr);
    grid-template-areas:
      "header header header"
      "squat deadlift press"
      "cal cal cal";
  }
}
h2 {
  grid-area: header;
  margin: 0;
}
h3 {
  margin: 4px 0 0 6px;
  color: #666;
}
h4 {
  margin: 5px 0;
}
body > div {
  background: #fff;
}
.squat {
  grid-area: squat;
}
.deadlift {
  grid-area: deadlift;
}
.press {
  grid-area: press;
}
.cal {
  grid-area: cal;
  background: #ddd;
  position: relative;
}
.cal-grid {
  position: relative;
  display: inline-block;
  font-size: 11px;
  line-height: 19px;
}
.cal-grid div {
  position: absolute;
  text-align: right;
}
svg#cal-legend {
  display: inline-block;
}
svg {
  display: block;
}
svg text {
  /* font-size: 8px; */
}
.tick {
}
.totals {
  font-size: 18px;
}
.totals .label {
  color: #666;
  padding-left: 10px;
}
</style>
<h2>Exercise 2018
<span class="totals">
  <span class="label">tons</span>
  <span id="tons"></span>
  <span class="label">wilks</span>
  <span id="wilks"></span>
</span></h2>
<div class="squat">
  <h3>Squat</h3>
  <svg id="squat-weight"></svg>
  <svg id="squat-reps"></svg>
  <svg id="squat-tonnage"></svg>
</div>
<div class="deadlift">
  <h3>Deadlift</h3>
  <svg id="deadlift-weight"></svg>
  <svg id="deadlift-reps"></svg>
  <svg id="deadlift-tonnage"></svg>
</div>
<div class="press">
  <h3>Press</h3>
  <svg id="press-weight"></svg>
  <svg id="press-reps"></svg>
  <svg id="press-tonnage"></svg>
</div>
<div class="cal">
  <h4>Daily tonnage in pounds for weeks in 2018</h4>
  <div class="cal-grid"></div>
  <svg id="cal-legend" width="160" height="160"></svg>
</div>
<script src="d3.js"></script>
<script src="d3-legend.js"></script>
<script src="date_fns.js"></script>
<script>
console.log(`d3 v${d3.version}`);

// see https://en.wikipedia.org/wiki/Wilks_Coefficient#Equation
// Values for men are:
const a = -216.0475144;
const b = 16.2606339;
const c = -0.002388645;
const d = -0.00113732;
const e = 7.01863e-6;
const f = -1.291e-8;
const lbs_in_kg = 2.20462262185;
// const lbs_in_kg = 2.2;
// Assume pounds for both bodyweight and lifted amounts
const wilksFormula = (bodyweight, lifted) => {
  const lifted_kg = lifted / lbs_in_kg;
  const x = bodyweight / lbs_in_kg;
  const denominator =
    a +
    b * x +
    c * Math.pow(x, 2) +
    d * Math.pow(x, 3) +
    e * Math.pow(x, 4) +
    f * Math.pow(x, 5);
  const wilks_coefficient = 500 / denominator;
  return wilks_coefficient * lifted_kg;
};

// see https://bl.ocks.org/mbostock/3883245
const renderChart = (exercise, dim, data, dates, w, h) => {
  var svg = d3.select(document.getElementById(`${exercise}-${dim}`));
  svg.selectAll("*").remove();
  var margin = { top: 10, right: 45, bottom: 30, left: 15 },
    width = w - margin.left - margin.right,
    height = h - margin.top - margin.bottom,
    g = svg
      .attr("width", w)
      .attr("height", h)
      .append("g")
      .attr("transform", `translate(${margin.left},${margin.top})`);

  var x = d3.scaleTime().rangeRound([0, width]);

  var y = d3.scaleLinear().rangeRound([height, 0]);

  var line = d3
    .line()
    .x(d => x(d.date))
    .y(d => y(d[dim]));

  const plate25lbs = "rgb(55, 106, 48)";
  const plate55lbs = "rgb(151, 70, 59)";
  const plate45lbs = "rgb(82, 89, 155)";
  const color = d3
    .scaleOrdinal()
    .domain(["deadlift", "squat", "press"])
    .range([plate55lbs, plate45lbs, plate25lbs]);
  x.domain(dates);
  y.domain([
    d3.min(data[exercise], d => d[dim]),
    d3.max(data[exercise], d => d[dim])
  ]);
  g
    .append("g")
    .attr("transform", `translate(0,${height})`)
    .call(d3.axisBottom(x).ticks(5))
    .select(".domain")
    .remove();
  g
    .append("g")
    .attr("transform", `translate(${width},0)`)
    .call(d3.axisRight(y).ticks(5))
    .append("text")
    .attr("fill", "#000")
    .attr("transform", "rotate(-90)")
    .attr("x", -height)
    .attr("y", -8)
    .attr("dy", "0.51em")
    .attr("text-anchor", "start")
    .text(
      dim === "weight"
        ? "weight (lbs)"
        : dim === "tonnage"
          ? "tonnage (lbs)"
          : dim === "reps" ? "reps (total)" : dim
    );
  g
    .append("path")
    .datum(data[exercise])
    .attr("class", "line")
    .attr("fill", "none")
    .attr("stroke", color(exercise))
    .attr("stroke-linejoin", "round")
    .attr("stroke-linecap", "round")
    .attr("stroke-width", 1.5)
    .attr("d", line);
  // see http://alignedleft.com/tutorials/d3/making-a-scatterplot
  // g
  //   .selectAll("circle")
  //   // .data(data[exercise])
  //   .enter()
  //   .append("circle")
  //   // .attr("fill", color(exercise))
  //   .attr("cx", d => x(d.date))
  //   .attr("cy", d => y(d[dim]))
  //   .attr("r", 5);
  g
    .selectAll("path.mark")
    .data(data[exercise])
    .enter()
    .append("path")
    .attr("class", "mark")
    .attr("fill", color(exercise))
    .attr("d", d => {
      const xp = x(d.date);
      const yp = y(d[dim]);
      const di = 9;
      const r = di / 2;
      const h = di / 3;
      // TODO consider if custom d3.symbol for the high / low / trap makes sense
      if (d.variant === "high") {
        return `M${xp - r},${yp} a1 0.8 0 1 1 ${di} 0`;
      }
      if (d.variant === "low") {
        return `M${xp - r},${yp} a1 0.8 0 0 0 ${di} 0`;
      }
      if (d.variant === "trap") {
        return `M${xp -
          r},${yp} l${h},-${h}l${h},0l${h},${h}l-${h},${h}l-${h},0l-${h},-${h}`;
      }
      return `M${xp - r},${yp} a1 1 0 1 1 ${di} 0 M${xp -
        r},${yp} a1 1 0 0 0 ${di} 0`;
    });
};

// https://developer.mozilla.org/en-US/docs/Web/Events/resize#requestAnimationFrame_customEvent
(function() {
  var throttle = function(type, name, obj) {
    obj = obj || window;
    var running = false;
    var func = function() {
      if (running) {
        return;
      }
      running = true;
      requestAnimationFrame(function() {
        obj.dispatchEvent(new CustomEvent(name));
        running = false;
      });
    };
    obj.addEventListener(type, func);
  };
  throttle("resize", "optimizedResize");
})();

// assume the csv is in the correct order so no sorting needed
d3
  .csv("2018.csv", r => {
    return {
      // assume date parse is sensible
      date: new Date(r.date),
      exercise: r.exercise.split(" ")[0],
      variant: r.exercise.split(" ")[1],
      tonnage: Number(r.tonnage),
      weight: Number(r["max weight"]),
      reps: Number(r["total reps"])
    };
  })
  .then(d => {
    const pounds = d3.sum(d, r => r.tonnage);
    document.getElementById("tons").innerHTML = (pounds / 2000).toLocaleString(
      "en-US",
      { maximumFractionDigits: 0 }
    );
    const nested = d3
      .nest()
      .key(r => r.exercise)
      .object(d);
    const [startDate, endDate] = d3.extent(d, r => r.date);
    // NOTE this avoids mutating the startDate in the data
    let startOfMonth = new Date(+startDate);
    startOfMonth.setDate(1);
    let dates = [startOfMonth, endDate];
    const maxWeek = d3.max(d.map(r => dateFns.getISOWeek(r.date)));
    const c = d3
      .scaleThreshold()
      .domain([1000, 5000, 7500, 10000])
      .range(d3.schemeBuPu[5]);
    const calData = d3
      .nest()
      .key(r => dateFns.getISOWeek(r.date))
      .key(r => dateFns.getISODay(r.date))
      .rollup(a => d3.sum(a, e => e.tonnage))
      .object(d);
    let calRoot = d3
      .select(".cal-grid")
      .style("height", 20 * 8 + "px")
      .style("width", 20 * (maxWeek + 1) + "px");
    let cellValue;
    const days = [null, "Mo", "Tu", "We", "Th", "Fr", "Sa", "Su"];
    for (let i = 0; i <= maxWeek; i++) {
      for (let j = 0; j <= 7; j++) {
        cellValue = (calData[i] || {})[j] || 0;
        calRoot
          .append("div")
          .style("background", c(cellValue))
          .style("width", "16px")
          .style("padding-right", "2px")
          .style("height", "18px")
          .style("left", i * 20 + "px")
          .style("top", j * 20 + "px")
          .attr("title", cellValue.toLocaleString())
          .text(i !== 0 ? (j === 0 ? i : null) : days[j]);
      }
    }

    var svg = d3.select("svg#cal-legend");

    svg
      .append("g")
      .attr("class", "legendThreshold")
      .attr("transform", "translate(15,10)");

    var legend = d3
      .legendColor()
      // assume this default label format string
      // .labelFormat(".01f")
      .labels(function({ i, genLength, generatedLabels }) {
        let wip = generatedLabels[i];
        // work with even 1000 values
        wip = wip.split("000.0").join("k");
        // or with even 500 values
        wip = wip.split("500.0").join(".5k");
        if (i === 0) {
          return wip.replace("NaN to", "Less than");
        } else if (i === genLength - 1) {
          return `More than ${wip.replace(" to NaN", "")}`;
        }
        return wip;
      })
      // .shapeWidth(10)
      // .shapeHeight(10)
      .scale(c);

    svg.select(".legendThreshold").call(legend);

    const maxPerExercise = d3
      .nest()
      .key(r => r.exercise)
      .rollup(a => d3.max(a, e => e.weight))
      .object(d);

    // NOTE this only pays attention to the 3 exercises to track the total for
    const maxTotal =
      maxPerExercise.press + maxPerExercise.squat + maxPerExercise.deadlift;
    document.getElementById("wilks").innerHTML = wilksFormula(
      200, // hardcoded bodyweight
      maxTotal
    ).toLocaleString("en-US", { maximumFractionDigits: 0 });
    const redraw = () => {
      // magic constants in portrait and landscape respectively are
      // 4 1 2 and 6 8 4
      const windowWidth = window.innerWidth;
      const www = Math.floor((windowWidth - 20) / 3);
      const hhh = Math.floor(www / 2.1);
      const ww = windowWidth - 10;
      const hh = Math.floor(ww / 2.85);
      const IS_NARROW = ww < 684;
      const w = IS_NARROW ? ww : www;
      const h = IS_NARROW ? hh : hhh;
      renderChart("squat", "weight", nested, dates, w, h);
      renderChart("deadlift", "weight", nested, dates, w, h);
      renderChart("press", "weight", nested, dates, w, h);
      renderChart("squat", "reps", nested, dates, w, h);
      renderChart("deadlift", "reps", nested, dates, w, h);
      renderChart("press", "reps", nested, dates, w, h);
      renderChart("squat", "tonnage", nested, dates, w, h);
      renderChart("deadlift", "tonnage", nested, dates, w, h);
      renderChart("press", "tonnage", nested, dates, w, h);
    };
    redraw();
    window.addEventListener("optimizedResize", function() {
      redraw();
    });
  });
</script>
